<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sherlock Homes - Single Family Home Loan Underwriting</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --secondary: #0f172a;
            --accent: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --bg-light: #f8fafc;
            --text-gray: #64748b;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--bg-light);
            color: var(--secondary);
            line-height: 1.6;
        }

        /* Navigation */
        nav {
            background: white;
            padding: 1rem 2rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            position: fixed;
            width: 100%;
            top: 0;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .logo svg {
            width: 32px;
            height: 32px;
        }

        .nav-links {
            display: flex;
            gap: 2rem;
            list-style: none;
        }

        .nav-links a {
            text-decoration: none;
            color: var(--secondary);
            font-weight: 500;
            transition: color 0.2s;
        }

        .nav-links a:hover {
            color: var(--primary);
        }

        .nav-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .nav-btn:hover {
            background: var(--primary-dark);
        }

        /* Hero Section */
        .hero {
            padding: 8rem 2rem 4rem;
            background: linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.6)), url('bgforthestats.jpg') center top/cover no-repeat;
            color: white;
            text-align: center;
        }

        .hero h1 {
            font-size: 3rem;
            margin-bottom: 1rem;
            font-weight: 800;
        }

        .hero p {
            font-size: 1.25rem;
            opacity: 0.9;
            max-width: 600px;
            margin: 0 auto 2rem;
        }

        .hero-stats {
            display: flex;
            justify-content: center;
            gap: 4rem;
            margin-top: 3rem;
        }

        .stat {
            text-align: center;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
        }

        .stat-label {
            opacity: 0.8;
            font-size: 0.9rem;
        }

        /* Main Content */
        .main-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 3rem 2rem;
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 2rem;
        }

        /* Dashboard Section */
        .dashboard {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        }

        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Application Cards */
        .applications {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
        }

        .app-card {
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.2s;
            background: white;
        }

        .app-card:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.15);
            transform: translateY(-2px);
        }

        .app-card-image {
            width: 100%;
            height: 160px;
            object-fit: cover;
            background: #e2e8f0;
        }

        .app-card-content {
            padding: 1.25rem;
        }

        .app-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.75rem;
        }

        .app-id {
            font-weight: 600;
            color: var(--secondary);
        }

        .app-type {
            font-size: 0.85rem;
            color: var(--text-gray);
        }

        .app-address {
            font-size: 0.9rem;
            color: var(--text-gray);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.35rem;
        }

        .app-address svg {
            flex-shrink: 0;
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-approved {
            background: #d1fae5;
            color: #065f46;
        }

        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }

        .status-review {
            background: #dbeafe;
            color: #1e40af;
        }

        .status-declined {
            background: #fee2e2;
            color: #991b1b;
        }

        .app-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .detail-item {
            font-size: 0.85rem;
        }

        .detail-label {
            color: var(--text-gray);
            margin-bottom: 0.25rem;
        }

        .detail-value {
            font-weight: 600;
        }

        .risk-score {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .risk-bar {
            flex: 1;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
        }

        .risk-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .risk-low { background: var(--accent); }
        .risk-medium { background: var(--warning); }
        .risk-high { background: var(--danger); }

        .card-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #e2e8f0;
        }

        .card-btn {
            flex: 1;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .btn-details {
            background: var(--bg-light);
            color: var(--secondary);
            border: 1px solid #e2e8f0;
        }

        .btn-details:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .btn-report {
            background: var(--secondary);
            color: white;
            border: none;
        }

        .btn-report:hover {
            background: #1e293b;
        }

        /* Report Modal */
        .report-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }

        .report-item {
            background: var(--bg-light);
            padding: 1rem;
            border-radius: 8px;
        }

        .report-item-label {
            font-size: 0.8rem;
            color: var(--text-gray);
            margin-bottom: 0.25rem;
        }

        .report-item-value {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .ai-notes {
            background: var(--secondary);
            color: white;
            padding: 1.5rem;
            border-radius: 8px;
        }

        .ai-notes h5 {
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .ai-notes ul {
            margin-left: 1.25rem;
            opacity: 0.9;
        }

        .ai-notes li {
            margin-bottom: 0.5rem;
        }

        /* Sidebar Form */
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        .form-card {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        }

        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-group label {
            display: block;
            font-weight: 500;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .form-row .form-group {
            margin-bottom: 0;
        }

        .submit-btn {
            width: 100%;
            background: var(--primary);
            color: white;
            border: none;
            padding: 1rem;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .submit-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }

        /* AI Analysis Panel */
        .analysis-panel {
            background: var(--secondary);
            color: white;
            border-radius: 16px;
            padding: 1.5rem;
        }

        .analysis-panel .section-title {
            color: white;
        }

        .ai-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
            padding: 0.75rem;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
        }

        .pulse {
            width: 10px;
            height: 10px;
            background: var(--accent);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }

        .analysis-items {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .analysis-item {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
        }

        .analysis-label {
            opacity: 0.8;
        }

        .analysis-value {
            font-weight: 600;
        }

        .analysis-value.positive { color: var(--accent); }
        .analysis-value.warning { color: var(--warning); }
        .analysis-value.negative { color: var(--danger); }

        /* Features Section */
        .features {
            background: white;
            padding: 4rem 2rem;
        }

        .features-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .features-title {
            text-align: center;
            font-size: 2rem;
            margin-bottom: 3rem;
        }

        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 2rem;
        }

        .feature-card {
            padding: 2rem;
            border-radius: 12px;
            background: var(--bg-light);
            text-align: center;
            transition: transform 0.2s;
        }

        .feature-card:hover {
            transform: translateY(-4px);
        }

        .feature-icon {
            width: 60px;
            height: 60px;
            background: var(--primary);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
        }

        .feature-icon svg {
            width: 30px;
            height: 30px;
            color: white;
        }

        .feature-card h3 {
            margin-bottom: 0.5rem;
        }

        .feature-card p {
            color: var(--text-gray);
            font-size: 0.9rem;
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-gray);
        }

        .modal-section {
            margin-bottom: 1.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid #e2e8f0;
        }

        .modal-section:last-of-type {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .modal-section h4 {
            margin-bottom: 1rem;
            color: var(--text-gray);
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Footer */
        footer {
            background: var(--secondary);
            color: white;
            padding: 2rem;
            text-align: center;
        }

        footer p {
            opacity: 0.7;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .hero h1 {
                font-size: 2rem;
            }

            .hero-stats {
                flex-direction: column;
                gap: 1.5rem;
            }

            .nav-links {
                display: none;
            }

            .applications {
                grid-template-columns: 1fr;
            }

            .app-details {
                grid-template-columns: 1fr 1fr;
            }

            .form-row {
                grid-template-columns: 1fr;
            }
        }

        /* Document Buttons */
        .doc-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .doc-btn {
            background: var(--bg-light);
            border: 1px dashed #cbd5e1;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--secondary);
        }

        .doc-btn:hover {
            border-color: var(--primary);
            background: #eff6ff;
            color: var(--primary);
        }

        .uploaded-docs {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .doc-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            font-size: 0.85rem;
        }

        .doc-item span {
            color: #166534;
        }

        .doc-remove {
            background: none;
            border: none;
            color: #dc2626;
            cursor: pointer;
            font-size: 1.1rem;
            line-height: 1;
            padding: 0 0.25rem;
        }

        .doc-remove:hover {
            color: #991b1b;
        }

        /* Loading Animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Loading Overlay */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.95);
            z-index: 10000;
        }

        .loading-overlay.active {
            display: block;
        }

        .loading-content {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: white;
            width: 90%;
            max-width: 500px;
            padding: 2rem;
        }

        .loading-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 2rem;
            position: relative;
            display: block;
            transform: translateX(-40px);
        }

        .loading-icon::before {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            border: 4px solid rgba(37, 99, 235, 0.2);
            border-radius: 50%;
        }

        .loading-icon::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            border: 4px solid transparent;
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .loading-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: var(--primary);
        }

        .loading-quip {
            font-size: 1.1rem;
            color: #94a3b8;
            min-height: 3rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.3s ease;
        }

        .loading-quip.fade {
            opacity: 0;
        }

        .loading-dots {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            margin-top: 2rem;
        }

        .loading-dots span {
            width: 8px;
            height: 8px;
            background: var(--primary);
            border-radius: 50%;
            animation: bounce 1.4s ease-in-out infinite;
        }

        .loading-dots span:nth-child(1) { animation-delay: 0s; }
        .loading-dots span:nth-child(2) { animation-delay: 0.2s; }
        .loading-dots span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0.6); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }

        /* Settings Section */
        .settings-section {
            padding: 4rem 2rem;
            background: var(--bg-light);
        }

        .settings-container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .settings-title {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--secondary);
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .settings-title svg {
            color: var(--primary);
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .settings-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .settings-card-header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 1rem 1.5rem;
        }

        .settings-card-header h3 {
            font-size: 1rem;
            font-weight: 600;
            margin: 0;
        }

        .settings-card-body {
            padding: 1.5rem;
        }

        .settings-field {
            margin-bottom: 1.25rem;
        }

        .settings-field:last-child {
            margin-bottom: 0;
        }

        .settings-field label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--secondary);
            margin-bottom: 0.5rem;
        }

        .settings-field small {
            display: block;
            font-size: 0.75rem;
            color: var(--text-gray);
            margin-top: 0.25rem;
        }

        .settings-input,
        .settings-select {
            width: 100%;
            padding: 0.625rem 0.875rem;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 0.875rem;
            color: var(--secondary);
            background: white;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .settings-input:focus,
        .settings-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .settings-toggle-field {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid #f1f5f9;
        }

        .settings-toggle-field:last-child {
            border-bottom: none;
        }

        .settings-toggle-field label:first-child {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--secondary);
            margin-bottom: 0;
        }

        .settings-toggle {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }

        .settings-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #cbd5e1;
            transition: 0.3s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        .settings-toggle input:checked + .toggle-slider {
            background-color: var(--accent);
        }

        .settings-toggle input:checked + .toggle-slider:before {
            transform: translateX(20px);
        }

        .settings-toggle input:disabled + .toggle-slider {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .settings-range-container {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .settings-range {
            flex: 1;
            height: 6px;
            -webkit-appearance: none;
            appearance: none;
            background: #e2e8f0;
            border-radius: 3px;
            outline: none;
        }

        .settings-range::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            background: var(--primary);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        .settings-range::-moz-range-thumb {
            width: 18px;
            height: 18px;
            background: var(--primary);
            border-radius: 50%;
            cursor: pointer;
            border: none;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        .settings-range-value {
            min-width: 40px;
            text-align: center;
            font-weight: 600;
            color: var(--primary);
        }

        .settings-api-key {
            display: flex;
            gap: 0.5rem;
        }

        .settings-api-key .settings-input {
            flex: 1;
            font-family: monospace;
        }

        .settings-btn-small {
            padding: 0.5rem 0.75rem;
            font-size: 0.75rem;
            font-weight: 500;
            border: 1px solid #e2e8f0;
            background: white;
            color: var(--secondary);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .settings-btn-small:hover {
            background: #f8fafc;
            border-color: var(--primary);
            color: var(--primary);
        }

        .settings-actions {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #e2e8f0;
        }

        .settings-btn-primary {
            padding: 0.75rem 2rem;
            font-size: 0.875rem;
            font-weight: 600;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .settings-btn-primary:hover {
            background: var(--primary-dark);
        }

        .settings-btn-secondary {
            padding: 0.75rem 2rem;
            font-size: 0.875rem;
            font-weight: 600;
            background: white;
            color: var(--secondary);
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .settings-btn-secondary:hover {
            background: #f8fafc;
            border-color: var(--text-gray);
        }

        @media (max-width: 768px) {
            .settings-grid {
                grid-template-columns: 1fr;
            }

            .settings-api-key {
                flex-wrap: wrap;
            }

            .settings-api-key .settings-input {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="loading-icon"></div>
            <div class="loading-title">Sherlock Homes is Investigating...</div>
            <div class="loading-quip" id="loadingQuip">Analyzing your application...</div>
            <div class="loading-dots">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
    </div>

    <!-- Navigation -->
    <nav>
        <div class="logo">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/>
                <polyline points="9 22 9 12 15 12 15 22"/>
            </svg>
            Sherlock Homes
        </div>
        <ul class="nav-links">
            <li><a href="underwriting-ai.html">Dashboard</a></li>
            <li><a href="applications.html">Applications</a></li>
            <li><a href="settings.html">Settings</a></li>
        </ul>
        <button class="nav-btn" onclick="openModal()">+ New Loan Application</button>
    </nav>

    <!-- Hero Section -->
    <section class="hero">
        <h1>AI-Powered Mortgage Underwriting</h1>
        <p>Streamline single family home loan decisions with intelligent risk assessment and automated document analysis.</p>
        <div class="hero-stats">
            <div class="stat">
                <div class="stat-value">99.4%</div>
                <div class="stat-label">Approval Accuracy</div>
            </div>
            <div class="stat">
                <div class="stat-value">9.5s</div>
                <div class="stat-label">Avg. Decision Time</div>
            </div>
        </div>
    </section>

    <!-- Main Content -->
    <main class="main-content" id="dashboard">
        <div class="dashboard">
            <h2 class="section-title">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="18" height="18" rx="2"/>
                    <path d="M3 9h18M9 21V9"/>
                </svg>
                Recent Loan Applications
            </h2>
            <div class="applications">
                <div class="app-card">
                    <img src="https://images.unsplash.com/photo-1564013799919-ab600027ffc6?w=400&h=300&fit=crop" alt="Property" class="app-card-image">
                    <div class="app-card-content">
                        <div class="app-header">
                            <div>
                                <div class="app-id">LN-2024-08472</div>
                                <div class="app-type">30-Year Fixed Conventional</div>
                            </div>
                            <span class="status-badge status-approved">Approved</span>
                        </div>
                        <div class="app-address">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/>
                                <circle cx="12" cy="10" r="3"/>
                            </svg>
                            1847 Oak Valley Dr, Austin, TX
                        </div>
                        <div class="app-details">
                            <div class="detail-item">
                                <div class="detail-label">Borrower</div>
                                <div class="detail-value">James Morrison</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Loan Amount</div>
                                <div class="detail-value">$1,420,000</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Property Value</div>
                                <div class="detail-value">$1,775,000</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">LTV</div>
                                <div class="detail-value">80.0%</div>
                            </div>
                        </div>
                        <div class="risk-score">
                            <span class="detail-label">Risk: 18</span>
                            <div class="risk-bar">
                                <div class="risk-fill risk-low" style="width: 18%"></div>
                            </div>
                        </div>
                        <div class="card-actions">
                            <button class="card-btn btn-details" onclick="showDetails('LN-2024-08472')">View Details</button>
                            <button class="card-btn btn-report" onclick="viewReport('LN-2024-08472')">View Report</button>
                        </div>
                    </div>
                </div>

                <div class="app-card">
                    <img src="https://images.unsplash.com/photo-1600596542815-ffad4c1539a9?w=400&h=300&fit=crop" alt="Property" class="app-card-image">
                    <div class="app-card-content">
                        <div class="app-header">
                            <div>
                                <div class="app-id">LN-2024-08471</div>
                                <div class="app-type">15-Year Fixed Conventional</div>
                            </div>
                            <span class="status-badge status-pending">Pending Docs</span>
                        </div>
                        <div class="app-address">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/>
                                <circle cx="12" cy="10" r="3"/>
                            </svg>
                            2234 Maple Creek Ln, Denver, CO
                        </div>
                        <div class="app-details">
                            <div class="detail-item">
                                <div class="detail-label">Borrower</div>
                                <div class="detail-value">Sarah Chen</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Loan Amount</div>
                                <div class="detail-value">$960,000</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Property Value</div>
                                <div class="detail-value">$1,280,000</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">LTV</div>
                                <div class="detail-value">75.0%</div>
                            </div>
                        </div>
                        <div class="risk-score">
                            <span class="detail-label">Risk: 32</span>
                            <div class="risk-bar">
                                <div class="risk-fill risk-low" style="width: 32%"></div>
                            </div>
                        </div>
                        <div class="card-actions">
                            <button class="card-btn btn-details" onclick="showDetails('LN-2024-08471')">View Details</button>
                            <button class="card-btn btn-report" onclick="viewReport('LN-2024-08471')">View Report</button>
                        </div>
                    </div>
                </div>

                <div class="app-card">
                    <img src="https://images.unsplash.com/photo-1600585154340-be6161a56a0c?w=400&h=300&fit=crop" alt="Property" class="app-card-image">
                    <div class="app-card-content">
                        <div class="app-header">
                            <div>
                                <div class="app-id">LN-2024-08470</div>
                                <div class="app-type">30-Year Fixed FHA</div>
                            </div>
                            <span class="status-badge status-review">Under Review</span>
                        </div>
                        <div class="app-address">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/>
                                <circle cx="12" cy="10" r="3"/>
                            </svg>
                            789 Sunset Blvd, Phoenix, AZ
                        </div>
                        <div class="app-details">
                            <div class="detail-item">
                                <div class="detail-label">Borrower</div>
                                <div class="detail-value">Michael Torres</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Loan Amount</div>
                                <div class="detail-value">$825,000</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Property Value</div>
                                <div class="detail-value">$865,000</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">LTV</div>
                                <div class="detail-value">95.4%</div>
                            </div>
                        </div>
                        <div class="risk-score">
                            <span class="detail-label">Risk: 58</span>
                            <div class="risk-bar">
                                <div class="risk-fill risk-medium" style="width: 58%"></div>
                            </div>
                        </div>
                        <div class="card-actions">
                            <button class="card-btn btn-details" onclick="showDetails('LN-2024-08470')">View Details</button>
                            <button class="card-btn btn-report" onclick="viewReport('LN-2024-08470')">View Report</button>
                        </div>
                    </div>
                </div>

                <div class="app-card">
                    <img src="https://images.unsplash.com/photo-1605276374104-dee2a0ed3cd6?w=400&h=300&fit=crop" alt="Property" class="app-card-image">
                    <div class="app-card-content">
                        <div class="app-header">
                            <div>
                                <div class="app-id">LN-2024-08469</div>
                                <div class="app-type">30-Year Fixed Conventional</div>
                            </div>
                            <span class="status-badge status-declined">Declined</span>
                        </div>
                        <div class="app-address">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/>
                                <circle cx="12" cy="10" r="3"/>
                            </svg>
                            456 Pine Ridge Way, Seattle, WA
                        </div>
                        <div class="app-details">
                            <div class="detail-item">
                                <div class="detail-label">Borrower</div>
                                <div class="detail-value">Robert Blake</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Loan Amount</div>
                                <div class="detail-value">$2,150,000</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Property Value</div>
                                <div class="detail-value">$2,250,000</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">LTV</div>
                                <div class="detail-value">95.6%</div>
                            </div>
                        </div>
                        <div class="risk-score">
                            <span class="detail-label">Risk: 84</span>
                            <div class="risk-bar">
                                <div class="risk-fill risk-high" style="width: 84%"></div>
                            </div>
                        </div>
                        <div class="card-actions">
                            <button class="card-btn btn-details" onclick="showDetails('LN-2024-08469')">View Details</button>
                            <button class="card-btn btn-report" onclick="viewReport('LN-2024-08469')">View Report</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="sidebar">
            <!-- Quick Submit Form -->
            <div class="form-card">
                <h3 class="section-title">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/>
                        <path d="M14 2v6h6M12 18v-6M9 15h6"/>
                    </svg>
                    Quick Pre-Qualification
                </h3>
                <form id="quickForm" onsubmit="runAssessment(event)">
                    <div class="form-group">
                        <label>Borrower Name</label>
                        <input type="text" id="qf_borrower_name" placeholder="Full legal name" required>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Credit Score</label>
                            <input type="number" id="qf_credit_score" placeholder="e.g., 720" min="300" max="850" required>
                        </div>
                        <div class="form-group">
                            <label>Annual Income</label>
                            <input type="number" id="qf_annual_income" placeholder="e.g., 85000" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Monthly Debts</label>
                            <input type="number" id="qf_monthly_debts" placeholder="e.g., 800" required>
                        </div>
                        <div class="form-group">
                            <label>Employment Years</label>
                            <input type="number" id="qf_employment_years" placeholder="e.g., 5" min="0" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Loan Amount</label>
                            <input type="number" id="qf_loan_amount" placeholder="e.g., 350000" required>
                        </div>
                        <div class="form-group">
                            <label>Property Value</label>
                            <input type="number" id="qf_property_value" placeholder="e.g., 425000" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Property Address</label>
                        <input type="text" id="qf_property_address" placeholder="123 Main St, City, State" required>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Loan Type</label>
                            <select id="qf_loan_type" required>
                                <option value="">Select loan type...</option>
                                <option value="30-Year Fixed Conventional">30-Year Fixed Conventional</option>
                                <option value="15-Year Fixed Conventional">15-Year Fixed Conventional</option>
                                <option value="30-Year Fixed FHA">30-Year Fixed FHA</option>
                                <option value="30-Year Fixed VA">30-Year Fixed VA</option>
                                <option value="7/1 ARM">7/1 ARM</option>
                                <option value="5/1 ARM">5/1 ARM</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Reserves (Months)</label>
                            <input type="number" id="qf_reserves_months" placeholder="e.g., 6" min="0" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>LinkedIn URL (Optional)</label>
                        <input type="url" id="qf_linkedin_url" placeholder="https://linkedin.com/in/...">
                    </div>
                    <button type="submit" class="submit-btn" id="qf_submit_btn">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <path d="M12 6v6l4 2"/>
                        </svg>
                        Run AI Assessment
                    </button>
                </form>
            </div>

            <!-- AI Analysis Panel -->
            <div class="analysis-panel">
                <h3 class="section-title">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2a10 10 0 1010 10H12V2z"/>
                        <path d="M12 2a10 10 0 00-8.5 15"/>
                    </svg>
                    AI Analysis Engine
                </h3>
                <div class="ai-indicator">
                    <div class="pulse"></div>
                    <span>System Active - Ready</span>
                </div>
                <div class="analysis-items">
                    <div class="analysis-item">
                        <span class="analysis-label">Credit Analysis</span>
                        <span class="analysis-value positive">Excellent</span>
                    </div>
                    <div class="analysis-item">
                        <span class="analysis-label">DTI Ratio</span>
                        <span class="analysis-value positive">32%</span>
                    </div>
                    <div class="analysis-item">
                        <span class="analysis-label">LTV Ratio</span>
                        <span class="analysis-value warning">89%</span>
                    </div>
                    <div class="analysis-item">
                        <span class="analysis-label">Income Verified</span>
                        <span class="analysis-value positive">Yes</span>
                    </div>
                    <div class="analysis-item">
                        <span class="analysis-label">Property Appraisal</span>
                        <span class="analysis-value warning">Pending</span>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Features Section -->
    <section class="features">
        <div class="features-container">
            <h2 class="features-title">Intelligent Mortgage Underwriting</h2>
            <div class="features-grid">
                <div class="feature-card">
                    <div class="feature-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
                        </svg>
                    </div>
                    <h3>Instant Decisions</h3>
                    <p>AI processes loan applications in seconds, providing immediate pre-qualification decisions.</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/>
                            <path d="M14 2v6h6M16 13H8M16 17H8M10 9H8"/>
                        </svg>
                    </div>
                    <h3>Document Analysis</h3>
                    <p>Automated extraction and verification of W-2s, tax returns, bank statements, and pay stubs.</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                        </svg>
                    </div>
                    <h3>Risk Assessment</h3>
                    <p>Comprehensive analysis of DTI, LTV, credit history, and employment stability.</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="1" y="4" width="22" height="16" rx="2"/>
                            <path d="M1 10h22"/>
                        </svg>
                    </div>
                    <h3>Compliance Check</h3>
                    <p>Automatic verification against Fannie Mae, Freddie Mac, FHA, and VA guidelines.</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Modal -->
    <div class="modal-overlay" id="modal">
        <div class="modal">
            <div class="modal-header">
                <h3>New Loan Application</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <form onsubmit="submitApplication(event)">
                <div class="modal-section">
                    <h4>Borrower Information</h4>
                    <div class="form-group">
                        <label>Full Legal Name *</label>
                        <input type="text" id="app_name" required>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>SSN *</label>
                            <input type="text" id="app_ssn" placeholder="XXX-XX-XXXX" required>
                        </div>
                        <div class="form-group">
                            <label>Date of Birth *</label>
                            <input type="date" id="app_dob" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Email *</label>
                            <input type="email" id="app_email" required>
                        </div>
                        <div class="form-group">
                            <label>Phone *</label>
                            <input type="tel" id="app_phone" required>
                        </div>
                    </div>
                </div>

                <div class="modal-section">
                    <h4>Employment & Income</h4>
                    <div class="form-group">
                        <label>Employer Name *</label>
                        <input type="text" id="app_employer" required>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Annual Income *</label>
                            <input type="number" id="app_income" placeholder="85000" required>
                        </div>
                        <div class="form-group">
                            <label>Years Employed *</label>
                            <input type="number" id="app_years_employed" min="0" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Credit Score *</label>
                            <input type="number" id="app_credit_score" placeholder="720" min="300" max="850" required>
                        </div>
                        <div class="form-group">
                            <label>Monthly Debts *</label>
                            <input type="number" id="app_monthly_debts" placeholder="800" required>
                        </div>
                    </div>
                </div>

                <div class="modal-section">
                    <h4>Loan Details</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Loan Amount *</label>
                            <input type="number" id="app_loan_amount" placeholder="350000" required>
                        </div>
                        <div class="form-group">
                            <label>Loan Type *</label>
                            <select id="app_loan_type" required>
                                <option value="">Select...</option>
                                <option value="30-Year Fixed Conventional">30-Year Fixed Conventional</option>
                                <option value="15-Year Fixed Conventional">15-Year Fixed Conventional</option>
                                <option value="30-Year Fixed FHA">30-Year Fixed FHA</option>
                                <option value="30-Year Fixed VA">30-Year Fixed VA</option>
                                <option value="7/1 ARM">7/1 ARM</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Loan Purpose *</label>
                        <select id="app_loan_purpose" required>
                            <option value="">Select...</option>
                            <option value="Purchase">Purchase</option>
                            <option value="Refinance - Rate/Term">Refinance - Rate/Term</option>
                            <option value="Refinance - Cash Out">Refinance - Cash Out</option>
                        </select>
                    </div>
                </div>

                <div class="modal-section">
                    <h4>Online Presence (Fourth Factor Analysis)</h4>
                    <p style="font-size: 0.85rem; color: var(--text-gray); margin-bottom: 1rem;">Social media profiles will be analyzed to verify identity and assess stability indicators.</p>
                    <div class="form-row">
                        <div class="form-group">
                            <label>LinkedIn Profile</label>
                            <input type="url" id="app_linkedin" placeholder="https://linkedin.com/in/...">
                        </div>
                        <div class="form-group">
                            <label>Facebook Profile</label>
                            <input type="url" id="app_facebook" placeholder="https://facebook.com/...">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Instagram Handle</label>
                            <input type="text" id="app_instagram" placeholder="@username">
                        </div>
                        <div class="form-group">
                            <label>Twitter/X Handle</label>
                            <input type="text" id="app_twitter" placeholder="@username">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Personal Website</label>
                        <input type="url" id="app_website" placeholder="https://...">
                    </div>
                    <div class="form-group">
                        <label>Other Social Links</label>
                        <textarea id="app_other_social" rows="2" placeholder="Any other relevant online profiles or links..."></textarea>
                    </div>
                </div>

                <div class="modal-section">
                    <h4>Tax Documents</h4>
                    <div class="doc-buttons">
                        <button type="button" class="doc-btn" onclick="addDocument('W-2')">+ W-2</button>
                        <button type="button" class="doc-btn" onclick="addDocument('1099')">+ 1099</button>
                        <button type="button" class="doc-btn" onclick="addDocument('Tax Return')">+ Tax Return</button>
                        <button type="button" class="doc-btn" onclick="addDocument('Pay Stub')">+ Pay Stub</button>
                        <button type="button" class="doc-btn" onclick="addDocument('Bank Statement')">+ Bank Statement</button>
                        <button type="button" class="doc-btn" onclick="addDocument('Other')">+ Other</button>
                    </div>
                    <div id="uploadedDocs" class="uploaded-docs"></div>
                </div>

                <div class="modal-section">
                    <h4>Other Relevant Information</h4>
                    <div class="form-group">
                        <label>Additional Notes</label>
                        <textarea id="app_notes" rows="4" placeholder="Any other information that may be relevant to this application (e.g., co-borrower details, unusual income sources, planned renovations, etc.)"></textarea>
                    </div>
                </div>

                <div class="modal-section">
                    <h4>Property Information</h4>
                    <div class="form-group">
                        <label>Property Address *</label>
                        <input type="text" id="app_property_address" placeholder="123 Main St, City, State ZIP" required>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Estimated Value *</label>
                            <input type="number" id="app_property_value" placeholder="425000" required>
                        </div>
                        <div class="form-group">
                            <label>Property Type *</label>
                            <select id="app_property_type" required>
                                <option value="">Select...</option>
                                <option value="Single Family Detached">Single Family Detached</option>
                                <option value="Townhouse">Townhouse</option>
                                <option value="Condo">Condo</option>
                                <option value="PUD">PUD</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Occupancy *</label>
                        <select id="app_occupancy" required>
                            <option value="">Select...</option>
                            <option value="Primary Residence">Primary Residence</option>
                            <option value="Second Home">Second Home</option>
                            <option value="Investment Property">Investment Property</option>
                        </select>
                    </div>
                </div>

                <button type="submit" class="submit-btn">
                    Submit for AI Underwriting
                </button>
            </form>
        </div>
    </div>

    <!-- Report Modal -->
    <div class="modal-overlay" id="reportModal">
        <div class="modal" style="max-width: 700px;">
            <div class="modal-header">
                <h3>AI Underwriting Report - <span id="reportAppId"></span></h3>
                <button class="modal-close" onclick="closeReportModal()">&times;</button>
            </div>

            <!-- Risk Score Summary -->
            <div class="modal-section" id="riskScoreSummary">
                <div style="text-align: center; padding: 1.5rem; background: var(--bg-light); border-radius: 12px;">
                    <div style="font-size: 0.9rem; color: var(--text-gray); margin-bottom: 0.5rem;">Composite Risk Score</div>
                    <div id="reportRiskScoreDisplay" style="font-size: 3rem; font-weight: 700; color: var(--accent);">18</div>
                    <div id="reportRiskCategory" style="font-size: 1.1rem; font-weight: 600;">Low Risk</div>
                    <div id="reportRecommendation" style="margin-top: 1rem; padding: 0.5rem 1rem; background: #d1fae5; color: #065f46; border-radius: 20px; display: inline-block; font-weight: 600;">APPROVE</div>
                </div>
            </div>

            <div class="modal-section">
                <h4>Loan Summary</h4>
                <div class="report-grid">
                    <div class="report-item">
                        <div class="report-item-label">Borrower</div>
                        <div class="report-item-value" id="reportBorrower">James Morrison</div>
                    </div>
                    <div class="report-item">
                        <div class="report-item-label">Loan Amount</div>
                        <div class="report-item-value" id="reportLoanAmount">$1,420,000</div>
                    </div>
                    <div class="report-item">
                        <div class="report-item-label">Property Value</div>
                        <div class="report-item-value" id="reportPropertyValue">$1,775,000</div>
                    </div>
                    <div class="report-item">
                        <div class="report-item-label">LTV Ratio</div>
                        <div class="report-item-value" id="reportLTV">80.0%</div>
                    </div>
                    <div class="report-item">
                        <div class="report-item-label">DTI Ratio</div>
                        <div class="report-item-value" id="reportDTI">32%</div>
                    </div>
                    <div class="report-item">
                        <div class="report-item-label">Loan Type</div>
                        <div class="report-item-value" id="reportLoanType">30-Year Fixed</div>
                    </div>
                </div>
            </div>

            <div class="modal-section">
                <h4>Risk Score Breakdown</h4>
                <div id="riskBreakdownContainer">
                    <div class="risk-breakdown-item" style="display: flex; justify-content: space-between; padding: 0.75rem; background: var(--bg-light); border-radius: 8px; margin-bottom: 0.5rem;">
                        <span>Credit Score Risk (35%)</span>
                        <span id="reportCreditRisk" style="font-weight: 600;">5.3 pts</span>
                    </div>
                    <div class="risk-breakdown-item" style="display: flex; justify-content: space-between; padding: 0.75rem; background: var(--bg-light); border-radius: 8px; margin-bottom: 0.5rem;">
                        <span>DTI Risk (25%)</span>
                        <span id="reportDTIRisk" style="font-weight: 600;">6.0 pts</span>
                    </div>
                    <div class="risk-breakdown-item" style="display: flex; justify-content: space-between; padding: 0.75rem; background: var(--bg-light); border-radius: 8px; margin-bottom: 0.5rem;">
                        <span>LTV Risk (20%)</span>
                        <span id="reportLTVRisk" style="font-weight: 600;">4.0 pts</span>
                    </div>
                    <div class="risk-breakdown-item" style="display: flex; justify-content: space-between; padding: 0.75rem; background: var(--bg-light); border-radius: 8px; margin-bottom: 0.5rem;">
                        <span>Employment Risk (10%)</span>
                        <span id="reportEmploymentRisk" style="font-weight: 600;">2.0 pts</span>
                    </div>
                    <div class="risk-breakdown-item" style="display: flex; justify-content: space-between; padding: 0.75rem; background: var(--bg-light); border-radius: 8px; margin-bottom: 0.5rem;">
                        <span>Reserves Risk (10%)</span>
                        <span id="reportReservesRisk" style="font-weight: 600;">1.5 pts</span>
                    </div>
                    <div class="risk-breakdown-item" style="display: flex; justify-content: space-between; padding: 0.75rem; background: #eff6ff; border-radius: 8px; border: 1px solid var(--primary);">
                        <span style="color: var(--primary);">Feature Modifiers</span>
                        <span id="reportModifiers" style="font-weight: 600; color: var(--primary);">-0.8 pts</span>
                    </div>
                </div>
            </div>

            <div class="modal-section">
                <h4>Borrower Analysis</h4>
                <div class="report-grid">
                    <div class="report-item">
                        <div class="report-item-label">Credit Score</div>
                        <div class="report-item-value" id="reportCredit">742</div>
                    </div>
                    <div class="report-item">
                        <div class="report-item-label">Annual Income</div>
                        <div class="report-item-value" id="reportIncome">$385,000</div>
                    </div>
                    <div class="report-item">
                        <div class="report-item-label">Monthly Debts</div>
                        <div class="report-item-value" id="reportDebts">$2,500</div>
                    </div>
                    <div class="report-item">
                        <div class="report-item-label">Employment</div>
                        <div class="report-item-value" id="reportEmployment">5 years</div>
                    </div>
                    <div class="report-item">
                        <div class="report-item-label">Reserves</div>
                        <div class="report-item-value" id="reportReserves">6 months</div>
                    </div>
                    <div class="report-item">
                        <div class="report-item-label">Property Address</div>
                        <div class="report-item-value" id="reportAddress" style="font-size: 0.85rem;">1847 Oak Valley Dr, Austin, TX</div>
                    </div>
                </div>
            </div>

            <div class="modal-section">
                <h4>AI Analysis Notes</h4>
                <div class="ai-notes">
                    <h5>
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <path d="M12 6v6l4 2"/>
                        </svg>
                        Sherlock Homes AI Assessment
                    </h5>
                    <div id="reportAnalysis" style="white-space: pre-wrap; line-height: 1.6; opacity: 0.9;">
                        Strong credit profile with consistent payment history. DTI ratio well within acceptable limits. Stable employment history indicates reliable income source.
                    </div>
                </div>
            </div>

            <div class="modal-section" style="text-align: center; margin-top: 1rem;">
                <button class="submit-btn" style="width: auto; padding: 0.75rem 2rem;" onclick="window.print()">Print Report</button>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer>
        <p>&copy; 2026 Sherlock Homes. Single Family Home Loan Underwriting Platform.</p>
    </footer>

    <script>
        const API_BASE = 'http://localhost:8000/api/v1';

        // Loading screen quips
        const loadingQuips = [
            "Examining credit history with a magnifying glass...",
            "Calculating debt-to-income ratios at the speed of light...",
            "Consulting the ancient scrolls of Fannie Mae...",
            "Making sure you're not secretly three kids in a trenchcoat...",
            "Checking if the property exists in this dimension...",
            "Running your numbers through our abacus...",
            "Asking the Magic 8-Ball for a second opinion...",
            "Verifying you haven't bought 47 houses this week...",
            "Cross-referencing with the Book of Mortgages...",
            "Teaching our AI the difference between a house and a castle...",
            "Ensuring your down payment isn't paid in cryptocurrency...",
            "Double-checking that 'Minecraft Road' is a real address...",
            "Investigating your employment history like a true detective...",
            "Making sure your credit score isn't just a high score in a video game...",
            "Confirming the seller isn't your imaginary friend...",
            "Reviewing your financial stability through the lens of chaos theory...",
            "Calculating the probability of success using advanced math wizardry...",
            "Ensuring the property isn't built on an ancient burial ground...",
            "Verifying your income isn't just Monopoly money...",
            "Checking if you've ever been evicted from a bouncy castle..."
        ];

        let quipInterval = null;
        let currentQuipIndex = 0;

        function showLoadingScreen() {
            const overlay = document.getElementById('loadingOverlay');
            const quipElement = document.getElementById('loadingQuip');

            // Reset and show
            currentQuipIndex = Math.floor(Math.random() * loadingQuips.length);
            quipElement.textContent = loadingQuips[currentQuipIndex];
            quipElement.classList.remove('fade');
            overlay.classList.add('active');

            // Cycle quips every 4.5 seconds
            quipInterval = setInterval(() => {
                quipElement.classList.add('fade');
                setTimeout(() => {
                    currentQuipIndex = (currentQuipIndex + 1) % loadingQuips.length;
                    quipElement.textContent = loadingQuips[currentQuipIndex];
                    quipElement.classList.remove('fade');
                }, 300);
            }, 4500);
        }

        function hideLoadingScreen() {
            const overlay = document.getElementById('loadingOverlay');
            overlay.classList.remove('active');
            if (quipInterval) {
                clearInterval(quipInterval);
                quipInterval = null;
            }
        }

        function openModal() {
            document.getElementById('modal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('active');
        }

        function generateDetailedAnalysis(formData, apiResult, creditRisk, dtiRisk, ltvRisk, fourthFactor = null) {
            const analysis = [];
            const creditScore = formData.credit_score;
            const dtiRatio = apiResult.dti_ratio;
            const ltvRatio = apiResult.ltv_ratio;
            const annualIncome = formData.annual_income;
            const loanAmount = formData.loan_amount;
            const propertyValue = formData.property_value;
            const employmentYears = formData.employment_years || 0;
            const reservesMonths = formData.reserves_months || 0;

            // Overall recommendation
            analysis.push(`RECOMMENDATION: ${apiResult.recommendation || 'Under Review'}`);
            analysis.push('');

            // Credit Score Analysis
            analysis.push(' CREDIT SCORE ANALYSIS ');
            if (creditScore >= 760) {
                analysis.push(`Credit Score: ${creditScore} (Excellent)`);
                analysis.push(' Qualifies for best available interest rates');
                analysis.push(' Strong credit history demonstrates reliable payment behavior');
                analysis.push(' No additional credit conditions required');
            } else if (creditScore >= 720) {
                analysis.push(`Credit Score: ${creditScore} (Very Good)`);
                analysis.push(' Qualifies for competitive interest rates');
                analysis.push(' Credit profile meets conventional loan standards');
                analysis.push(' Minor rate adjustment may apply vs. excellent credit tier');
            } else if (creditScore >= 680) {
                analysis.push(`Credit Score: ${creditScore} (Good)`);
                analysis.push(' Meets minimum requirements for conventional loans');
                analysis.push(' May qualify for FHA with better terms');
                analysis.push(' Consider credit improvement for better rates');
            } else if (creditScore >= 640) {
                analysis.push(`Credit Score: ${creditScore} (Fair)`);
                analysis.push(' Limited to FHA or subprime conventional products');
                analysis.push(' Higher interest rates will apply');
                analysis.push(' Recommend reviewing credit report for errors');
            } else {
                analysis.push(`Credit Score: ${creditScore} (Needs Improvement)`);
                analysis.push(' Below minimum threshold for most loan products');
                analysis.push(' Consider credit counseling before applying');
                analysis.push(' May require co-signer or alternative documentation');
            }
            analysis.push(`Risk Points: ${creditRisk}/35`);
            analysis.push('');

            // DTI Analysis
            analysis.push(' DEBT-TO-INCOME ANALYSIS ');
            const monthlyIncome = annualIncome / 12;
            const estimatedPayment = apiResult.estimated_monthly_payment || (loanAmount * 0.006);
            analysis.push(`Monthly Gross Income: ${formatCurrency(monthlyIncome)}`);
            analysis.push(`Estimated Monthly Payment: ${formatCurrency(estimatedPayment)}`);
            analysis.push(`Total DTI Ratio: ${dtiRatio.toFixed(1)}%`);

            if (dtiRatio <= 28) {
                analysis.push(' Excellent debt management - well within guidelines');
                analysis.push(' Strong capacity to handle mortgage payments');
                analysis.push(' Low risk of payment stress');
            } else if (dtiRatio <= 36) {
                analysis.push(' Good debt ratio within conventional guidelines');
                analysis.push(' Adequate income buffer for expenses');
                analysis.push(' Meets Fannie Mae standard requirements');
            } else if (dtiRatio <= 43) {
                analysis.push(' Approaching upper limit of qualified mortgage standards');
                analysis.push(' May require compensating factors (reserves, credit score)');
                analysis.push(' Limited flexibility for additional debt');
            } else if (dtiRatio <= 50) {
                analysis.push(' Exceeds standard guidelines - requires exceptions');
                analysis.push(' Strong compensating factors mandatory');
                analysis.push(' Consider reducing loan amount or paying down debt');
            } else {
                analysis.push(' DTI exceeds maximum allowable thresholds');
                analysis.push(' Application likely to be declined without changes');
                analysis.push(' Recommend debt payoff or income increase before proceeding');
            }
            analysis.push(`Risk Points: ${dtiRisk}/35`);
            analysis.push('');

            // LTV Analysis
            analysis.push(' LOAN-TO-VALUE ANALYSIS ');
            const downPayment = propertyValue - loanAmount;
            const downPaymentPercent = (downPayment / propertyValue * 100).toFixed(1);
            analysis.push(`Loan Amount: ${formatCurrency(loanAmount)}`);
            analysis.push(`Property Value: ${formatCurrency(propertyValue)}`);
            analysis.push(`Down Payment: ${formatCurrency(downPayment)} (${downPaymentPercent}%)`);
            analysis.push(`LTV Ratio: ${ltvRatio.toFixed(1)}%`);

            if (ltvRatio <= 80) {
                analysis.push(' No Private Mortgage Insurance (PMI) required');
                analysis.push(' Strong equity position protects against market fluctuations');
                analysis.push(' Qualifies for best loan terms');
            } else if (ltvRatio <= 90) {
                analysis.push(' PMI required until 80% LTV achieved');
                analysis.push(' Moderate equity cushion');
                analysis.push(' Standard conventional loan eligible');
            } else if (ltvRatio <= 95) {
                analysis.push(' High LTV - PMI required');
                analysis.push(' Limited equity increases lender risk');
                analysis.push(' May qualify for FHA (96.5% max) or conventional 95%');
            } else {
                analysis.push(' Very high LTV - limited loan options');
                analysis.push(' Consider larger down payment');
                analysis.push(' VA loans allow 100% LTV for eligible veterans');
            }
            analysis.push(`Risk Points: ${ltvRisk}/30`);
            analysis.push('');

            // Employment & Reserves
            analysis.push(' STABILITY FACTORS ');
            if (employmentYears >= 2) {
                analysis.push(`Employment History: ${employmentYears} years (Meets standard)`);
                analysis.push(' Stable employment supports income reliability');
            } else if (employmentYears >= 1) {
                analysis.push(`Employment History: ${employmentYears} year(s) (Marginal)`);
                analysis.push(' May require additional income documentation');
            } else {
                analysis.push(`Employment History: ${employmentYears} years (Insufficient)`);
                analysis.push(' 2-year employment history typically required');
            }

            if (reservesMonths >= 6) {
                analysis.push(`Cash Reserves: ${reservesMonths} months (Strong)`);
                analysis.push(' Excellent financial cushion for emergencies');
            } else if (reservesMonths >= 2) {
                analysis.push(`Cash Reserves: ${reservesMonths} months (Adequate)`);
                analysis.push(' Meets minimum reserve requirements');
            } else {
                analysis.push(`Cash Reserves: ${reservesMonths} months (Low)`);
                analysis.push(' Consider building reserves before closing');
            }
            analysis.push('');

            // Social Media Analysis (Fourth Factor)
            if (fourthFactor && fourthFactor.sources && fourthFactor.sources.length > 0) {
                analysis.push(' SOCIAL MEDIA INSIGHTS (FOURTH FACTOR) ');
                analysis.push(`Profiles Analyzed: ${fourthFactor.sources.length}`);

                if (fourthFactor.professional_summary) {
                    analysis.push('');
                    analysis.push('Professional Profile:');
                    const profLines = fourthFactor.professional_summary.split('\n');
                    profLines.slice(0, 3).forEach(line => {
                        if (line.trim()) analysis.push(` ${line.trim()}`);
                    });
                }

                if (fourthFactor.lifestyle_summary) {
                    analysis.push('');
                    analysis.push('Lifestyle Indicators:');
                    const lifeLines = fourthFactor.lifestyle_summary.split('\n');
                    lifeLines.slice(0, 3).forEach(line => {
                        if (line.trim()) analysis.push(` ${line.trim()}`);
                    });
                }

                if (fourthFactor.positive_indicators && fourthFactor.positive_indicators.length > 0) {
                    analysis.push('');
                    analysis.push('Positive Indicators:');
                    fourthFactor.positive_indicators.slice(0, 3).forEach(indicator => {
                        analysis.push(` ${indicator}`);
                    });
                }

                if (fourthFactor.red_flags && fourthFactor.red_flags.length > 0) {
                    analysis.push('');
                    analysis.push('Items to Review:');
                    fourthFactor.red_flags.slice(0, 3).forEach(flag => {
                        analysis.push(` ${flag}`);
                    });
                }

                if (fourthFactor.additional_findings) {
                    analysis.push('');
                    analysis.push(fourthFactor.additional_findings);
                }

                analysis.push('');
            }

            // Final Summary
            analysis.push(' SUMMARY ');
            const totalRisk = creditRisk + dtiRisk + ltvRisk;
            analysis.push(`Total Risk Score: ${totalRisk}/100`);

            if (totalRisk <= 30) {
                analysis.push('This application presents LOW RISK with strong fundamentals across all key metrics. Recommend approval with standard terms.');
            } else if (totalRisk <= 50) {
                analysis.push('This application presents MODERATE RISK with some areas requiring attention. Approval likely with standard documentation.');
            } else if (totalRisk <= 70) {
                analysis.push('This application presents ELEVATED RISK. Manual underwriter review recommended. Additional documentation or conditions may be required.');
            } else {
                analysis.push('This application presents HIGH RISK. Significant concerns identified. Consider restructuring the loan or addressing credit/debt issues before reapplication.');
            }

            return analysis.join('\n');
        }

        async function submitApplication(e) {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<div class="loading"></div> Processing...';
            btn.disabled = true;

            // Show the loading screen with quips
            showLoadingScreen();

            // Collect social media URLs
            const linkedinUrl = document.getElementById('app_linkedin').value || null;
            const facebookUrl = document.getElementById('app_facebook').value || null;
            const instagramHandle = document.getElementById('app_instagram').value || null;
            const twitterHandle = document.getElementById('app_twitter').value || null;

            // Build full application request matching LoanApplicationRequest schema
            const formData = {
                applicant: {
                    full_name: document.getElementById('app_name').value,
                    email: document.getElementById('app_email').value,
                    phone: document.getElementById('app_phone').value,
                    employer_name: document.getElementById('app_employer').value || null,
                    annual_income: parseFloat(document.getElementById('app_income').value),
                    years_employed: parseFloat(document.getElementById('app_years_employed').value) || 0,
                    credit_score: parseInt(document.getElementById('app_credit_score').value),
                    linkedin_url: linkedinUrl,
                    facebook_url: facebookUrl,
                    instagram_handle: instagramHandle,
                    twitter_handle: twitterHandle
                },
                property_info: {
                    address: document.getElementById('app_property_address').value,
                    estimated_value: parseFloat(document.getElementById('app_property_value').value),
                    property_type: "Single Family Detached",
                    occupancy: "Primary Residence"
                },
                loan_details: {
                    loan_amount: parseFloat(document.getElementById('app_loan_amount').value),
                    loan_type: document.getElementById('app_loan_type').value,
                    loan_purpose: "Purchase"
                }
            };

            const displayData = {
                borrower_name: formData.applicant.full_name,
                credit_score: formData.applicant.credit_score,
                annual_income: formData.applicant.annual_income,
                monthly_debts: parseFloat(document.getElementById('app_monthly_debts').value),
                loan_amount: formData.loan_details.loan_amount,
                property_value: formData.property_info.estimated_value,
                loan_type: formData.loan_details.loan_type,
                employment_years: formData.applicant.years_employed,
                property_address: formData.property_info.address,
                reserves_months: 6,
                has_social_media: !!(linkedinUrl || facebookUrl || instagramHandle || twitterHandle)
            };

            try {
                const response = await fetch(`${API_BASE}/loan-applications`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Failed to process application');
                }

                const result = await response.json();
                console.log('Full Application API Response:', result);

                // Extract data from LoanApplicationResponse
                const riskAssessment = result.risk_assessment || {};
                const fourthFactor = result.fourth_factor || null;
                const aiSummary = result.ai_summary || {};

                // Calculate breakdown to match backend logic
                const creditScore = displayData.credit_score;
                const dtiRatio = riskAssessment.dti_ratio || 0;
                const ltvRatio = riskAssessment.ltv_ratio || 0;

                // Credit score component (0-35 points)
                let creditRisk = 0;
                if (creditScore >= 760) creditRisk = 0;
                else if (creditScore >= 720) creditRisk = 10;
                else if (creditScore >= 680) creditRisk = 20;
                else if (creditScore >= 640) creditRisk = 28;
                else creditRisk = 35;

                // DTI ratio component (0-35 points)
                let dtiRisk = 0;
                if (dtiRatio <= 28) dtiRisk = 0;
                else if (dtiRatio <= 36) dtiRisk = 10;
                else if (dtiRatio <= 43) dtiRisk = 20;
                else if (dtiRatio <= 50) dtiRisk = 28;
                else dtiRisk = 35;

                // LTV ratio component (0-30 points)
                let ltvRisk = 0;
                if (ltvRatio <= 80) ltvRisk = 0;
                else if (ltvRatio <= 90) ltvRisk = 10;
                else if (ltvRatio <= 95) ltvRisk = 20;
                else ltvRisk = 30;

                // Generate detailed AI analysis FIRST (including social media if available)
                let aiAnalysis = generateDetailedAnalysis(displayData, riskAssessment, creditRisk, dtiRisk, ltvRisk, fourthFactor);

                // Prepend AI summary if available
                if (aiSummary.summary) {
                    aiAnalysis = ' SHERLOCK HOMES AI ASSESSMENT \n' + aiSummary.summary + '\n\n' + aiAnalysis;
                }

                // Now parse the LAST X/100 score from the full analysis text
                // This will be the "Total Risk Score: X/100" at the bottom of the summary
                let finalRiskScore = riskAssessment.risk_score || 0;
                const scoreMatches = aiAnalysis.match(/(\d+)\/100/g);
                if (scoreMatches && scoreMatches.length > 0) {
                    // Get the LAST match that isn't 100/100
                    for (let i = scoreMatches.length - 1; i >= 0; i--) {
                        const score = parseInt(scoreMatches[i].split('/')[0]);
                        if (score !== 100) {
                            finalRiskScore = score;
                            console.log('Parsed risk score from analysis summary:', finalRiskScore);
                            break;
                        }
                    }
                }
                console.log('Final risk score:', finalRiskScore);

                // Determine risk category based on the parsed score
                let riskCategory;
                if (finalRiskScore <= 30) riskCategory = 'Low Risk';
                else if (finalRiskScore <= 50) riskCategory = 'Moderate Risk';
                else if (finalRiskScore <= 70) riskCategory = 'Elevated Risk';
                else riskCategory = 'High Risk';

                const report = {
                    application_id: result.application_id,
                    risk_score: finalRiskScore,
                    risk_category: riskCategory,
                    ltv: ltvRatio,
                    dti: dtiRatio,
                    ai_analysis: aiAnalysis,
                    fourth_factor: fourthFactor,
                    ai_summary: aiSummary,
                    score_breakdown: {
                        credit_risk: creditRisk,
                        dti_risk: dtiRisk,
                        ltv_risk: ltvRisk,
                        employment_risk: 0,
                        reserves_risk: 0,
                        feature_modifiers: 0
                    }
                };

                // Hide loading screen and show results
                hideLoadingScreen();
                closeModal();
                displayReport(report, displayData);

            } catch (error) {
                console.error('API Error:', error);
                hideLoadingScreen();
                alert('Failed to process application.\n\nError: ' + error.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        async function runAssessment(e) {
            e.preventDefault();
            const btn = document.getElementById('qf_submit_btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<div class="loading"></div> Analyzing...';
            btn.disabled = true;

            // Show the loading screen with quips
            showLoadingScreen();

            // Collect form data matching QuickAssessmentRequest schema
            const formData = {
                borrower_name: document.getElementById('qf_borrower_name').value,
                credit_score: parseInt(document.getElementById('qf_credit_score').value),
                annual_income: parseFloat(document.getElementById('qf_annual_income').value),
                monthly_debts: parseFloat(document.getElementById('qf_monthly_debts').value),
                loan_amount: parseFloat(document.getElementById('qf_loan_amount').value),
                property_value: parseFloat(document.getElementById('qf_property_value').value),
                loan_type: document.getElementById('qf_loan_type').value
            };

            // Store additional form data for display
            const displayData = {
                ...formData,
                employment_years: parseInt(document.getElementById('qf_employment_years').value),
                property_address: document.getElementById('qf_property_address').value,
                reserves_months: parseInt(document.getElementById('qf_reserves_months').value),
                linkedin_url: document.getElementById('qf_linkedin_url').value || null
            };

            try {
                const response = await fetch(`${API_BASE}/quick-assessment`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Failed to process application');
                }

                const result = await response.json();
                console.log('API Response:', result);

                // Calculate breakdown to match backend logic
                const creditScore = displayData.credit_score;
                const dtiRatio = result.dti_ratio || 0;
                const ltvRatio = result.ltv_ratio || 0;

                // Credit score component (0-35 points) - matches backend
                let creditRisk = 0;
                if (creditScore >= 760) creditRisk = 0;
                else if (creditScore >= 720) creditRisk = 10;
                else if (creditScore >= 680) creditRisk = 20;
                else if (creditScore >= 640) creditRisk = 28;
                else creditRisk = 35;

                // DTI ratio component (0-35 points) - matches backend
                let dtiRisk = 0;
                if (dtiRatio <= 28) dtiRisk = 0;
                else if (dtiRatio <= 36) dtiRisk = 10;
                else if (dtiRatio <= 43) dtiRisk = 20;
                else if (dtiRatio <= 50) dtiRisk = 28;
                else dtiRisk = 35;

                // LTV ratio component (0-30 points) - matches backend
                let ltvRisk = 0;
                if (ltvRatio <= 80) ltvRisk = 0;
                else if (ltvRatio <= 90) ltvRisk = 10;
                else if (ltvRatio <= 95) ltvRisk = 20;
                else ltvRisk = 30;

                // Generate detailed AI analysis
                const aiAnalysis = generateDetailedAnalysis(displayData, result, creditRisk, dtiRisk, ltvRisk);

                // Convert QuickAssessmentResponse to report format for displayReport
                const report = {
                    risk_score: result.risk_score,
                    risk_category: (result.risk_level || 'unknown').charAt(0).toUpperCase() + (result.risk_level || 'unknown').slice(1) + ' Risk',
                    ltv: ltvRatio,
                    dti: dtiRatio,
                    ai_analysis: aiAnalysis,
                    score_breakdown: {
                        credit_risk: creditRisk,
                        dti_risk: dtiRisk,
                        ltv_risk: ltvRisk,
                        employment_risk: 0,
                        reserves_risk: 0,
                        feature_modifiers: 0
                    }
                };
                console.log('Report object:', report);
                console.log('Display data:', displayData);
                try {
                    hideLoadingScreen();
                    displayReport(report, displayData);
                    console.log('displayReport completed - modal should be visible');
                } catch (displayError) {
                    console.error('Error in displayReport:', displayError);
                    hideLoadingScreen();
                    alert('Risk Score: ' + result.risk_score + '\nRisk Level: ' + result.risk_level + '\nRecommendation: ' + result.recommendation);
                }
            } catch (error) {
                console.error('API Error:', error);
                hideLoadingScreen();
                alert('Failed to connect to the server. Make sure the API server is running on localhost:8000\n\nError: ' + error.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        function displayReport(report, formData) {
            console.log('displayReport called with:', { report, formData });

            // Set App ID
            document.getElementById('reportAppId').textContent = 'NEW-' + Date.now().toString().slice(-6);

            // Risk Score Display
            const riskScore = report.risk_score;
            const riskDisplay = document.getElementById('reportRiskScoreDisplay');
            const riskCategory = document.getElementById('reportRiskCategory');
            const recommendation = document.getElementById('reportRecommendation');

            riskDisplay.textContent = riskScore;
            riskCategory.textContent = report.risk_category;

            // Color based on risk level
            if (riskScore <= 30) {
                riskDisplay.style.color = 'var(--accent)';
                recommendation.style.background = '#d1fae5';
                recommendation.style.color = '#065f46';
                recommendation.textContent = 'APPROVE';
            } else if (riskScore <= 50) {
                riskDisplay.style.color = 'var(--warning)';
                recommendation.style.background = '#fef3c7';
                recommendation.style.color = '#92400e';
                recommendation.textContent = 'CONDITIONAL APPROVE';
            } else if (riskScore <= 70) {
                riskDisplay.style.color = '#f97316';
                recommendation.style.background = '#ffedd5';
                recommendation.style.color = '#9a3412';
                recommendation.textContent = 'REVIEW REQUIRED';
            } else {
                riskDisplay.style.color = 'var(--danger)';
                recommendation.style.background = '#fee2e2';
                recommendation.style.color = '#991b1b';
                recommendation.textContent = 'DECLINE';
            }

            // Loan Summary
            document.getElementById('reportBorrower').textContent = formData.borrower_name;
            document.getElementById('reportLoanAmount').textContent = formatCurrency(formData.loan_amount);
            document.getElementById('reportPropertyValue').textContent = formatCurrency(formData.property_value);
            document.getElementById('reportLTV').textContent = report.ltv.toFixed(1) + '%';
            document.getElementById('reportDTI').textContent = report.dti.toFixed(1) + '%';
            document.getElementById('reportLoanType').textContent = formData.loan_type;

            // Risk Breakdown
            const breakdown = report.score_breakdown;
            document.getElementById('reportCreditRisk').textContent = breakdown.credit_risk.toFixed(1) + ' pts';
            document.getElementById('reportDTIRisk').textContent = breakdown.dti_risk.toFixed(1) + ' pts';
            document.getElementById('reportLTVRisk').textContent = breakdown.ltv_risk.toFixed(1) + ' pts';
            document.getElementById('reportEmploymentRisk').textContent = breakdown.employment_risk.toFixed(1) + ' pts';
            document.getElementById('reportReservesRisk').textContent = breakdown.reserves_risk.toFixed(1) + ' pts';

            const modifiers = breakdown.feature_modifiers || 0;
            const modifiersEl = document.getElementById('reportModifiers');
            modifiersEl.textContent = (modifiers >= 0 ? '+' : '') + modifiers.toFixed(1) + ' pts';
            modifiersEl.style.color = modifiers <= 0 ? 'var(--accent)' : 'var(--danger)';

            // Borrower Analysis
            document.getElementById('reportCredit').textContent = formData.credit_score;
            document.getElementById('reportIncome').textContent = formatCurrency(formData.annual_income);
            document.getElementById('reportDebts').textContent = formatCurrency(formData.monthly_debts) + '/mo';
            document.getElementById('reportEmployment').textContent = formData.employment_years + ' years';
            document.getElementById('reportReserves').textContent = formData.reserves_months + ' months';
            document.getElementById('reportAddress').textContent = formData.property_address;

            // AI Analysis
            const analysisEl = document.getElementById('reportAnalysis');
            if (report.ai_analysis) {
                analysisEl.textContent = report.ai_analysis;
            } else {
                // Generate basic analysis if AI analysis not available
                let analysis = [];
                if (formData.credit_score >= 740) {
                    analysis.push('Excellent credit score indicates strong repayment history.');
                } else if (formData.credit_score >= 680) {
                    analysis.push('Good credit score meets conventional loan requirements.');
                } else {
                    analysis.push('Credit score below optimal range - may require additional documentation.');
                }

                if (report.dti <= 36) {
                    analysis.push('DTI ratio is within healthy limits for loan approval.');
                } else if (report.dti <= 43) {
                    analysis.push('DTI ratio is acceptable but approaching upper limits.');
                } else {
                    analysis.push('High DTI ratio presents elevated repayment risk.');
                }

                if (report.ltv <= 80) {
                    analysis.push('Strong LTV ratio - no PMI required.');
                } else if (report.ltv <= 95) {
                    analysis.push('LTV ratio acceptable for FHA/conventional with PMI.');
                } else {
                    analysis.push('High LTV ratio indicates limited equity buffer.');
                }

                if (formData.employment_years >= 2) {
                    analysis.push('Stable employment history supports income reliability.');
                } else {
                    analysis.push('Short employment tenure - verify income stability.');
                }

                analysisEl.textContent = analysis.join('\n\n');
            }

            // Show the report modal
            console.log('About to show modal...');
            const modal = document.getElementById('reportModal');
            console.log('Modal element:', modal);
            modal.classList.add('active');
            console.log('Modal should now be visible, classList:', modal.classList);
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }

        function showDetails(appId) {
            alert(`Viewing loan details for ${appId}\n\nFull application details, documents, and underwriting notes would display here.`);
        }

        async function viewReport(appId) {
            // Try to fetch from API first
            try {
                const response = await fetch(`${API_BASE}/loan-applications/${appId}`);
                if (response.ok) {
                    const result = await response.json();
                    if (result.risk_assessment) {
                        const report = {
                            risk_score: result.risk_assessment.risk_score,
                            risk_category: result.risk_assessment.risk_level,
                            ltv: result.risk_assessment.ltv_ratio,
                            dti: result.risk_assessment.dti_ratio,
                            ai_analysis: result.risk_assessment.recommendation
                        };
                        displayReport(report, {
                            borrower_name: appId,
                            loan_amount: 0,
                            property_value: 0,
                            credit_score: 0,
                            annual_income: 0,
                            monthly_debts: 0,
                            employment_years: 0,
                            reserves_months: 0,
                            property_address: '',
                            loan_type: ''
                        });
                        return;
                    }
                }
            } catch (error) {
                console.log('Could not fetch from API, showing static data');
            }

            // Fallback to static display
            document.getElementById('reportAppId').textContent = appId;
            document.getElementById('reportModal').classList.add('active');
        }

        function closeReportModal() {
            document.getElementById('reportModal').classList.remove('active');
        }

        let docCounter = 0;
        function addDocument(type) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.pdf,.jpg,.jpeg,.png,.doc,.docx';
            input.onchange = function(e) {
                if (e.target.files.length > 0) {
                    const fileName = e.target.files[0].name;
                    const container = document.getElementById('uploadedDocs');
                    const docId = 'doc-' + (++docCounter);
                    const docItem = document.createElement('div');
                    docItem.className = 'doc-item';
                    docItem.id = docId;
                    docItem.innerHTML = `<span>${type}: ${fileName}</span><button type="button" class="doc-remove" onclick="removeDocument('${docId}')">&times;</button>`;
                    container.appendChild(docItem);
                }
            };
            input.click();
        }

        function removeDocument(docId) {
            document.getElementById(docId).remove();
        }

        // Close modal on outside click
        document.getElementById('modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });

        document.getElementById('reportModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeReportModal();
            }
        });

        // Escape key closes modals
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeModal();
                closeReportModal();
            }
        });

        // Check API health on load
        window.addEventListener('load', async function() {
            try {
                const response = await fetch(`${API_BASE}/health`);
                const data = await response.json();
                if (data.status === 'healthy') {
                    console.log('Sherlock Homes API connected - Version:', data.version);
                }
            } catch (error) {
                console.warn('API server not running. Start with: cd backend && python -m uvicorn app.main:app --reload --port 8000');
            }
        });
    </script>
</body>
</html>
